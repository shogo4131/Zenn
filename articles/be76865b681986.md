---
title: "App Routerã§å­¦ã¶ãƒ†ã‚¹ãƒˆå®Ÿè·µä¼šã®ãƒ¬ãƒãƒ¼ãƒˆ"
emoji: "ğŸ“"
type: "tech"
topics: ["React", "Nextjs", "AppRouter", "frontend", "Tech"]
published: true
published_at: 2024-12-16 08:00
---

## ã¯ã˜ã‚ã«

å…ˆæ—¥(2024/11/30)ã«ã€ŒApp Router ã§å­¦ã¶ãƒ†ã‚¹ãƒˆå®Ÿè·µä¼šã€ã‚’ä¸»å‚¬ã—ã¾ã—ãŸã€‚

https://devguil.connpass.com/event/336183/

ã“ã®å‹‰å¼·ä¼šã‚’é–‹å‚¬ã—ãŸãã£ã‹ã‘ã¯ã€ç­†è€…å«ã‚ App Router ã®ãƒ†ã‚¹ãƒˆã«é–¢ã—ã¦æƒ…å ±ãŒå°‘ãªãã€ä»–ç¤¾ã®ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ãŒãƒ†ã‚¹ãƒˆã‚’ã©ã®ã‚ˆã†ã«è¡Œã£ã¦ã„ã‚‹ã‹ã‚’çŸ¥ã‚ŠãŸã„ã¨ã„ã†æ€ã„ãŒã‚ã£ãŸã‹ã‚‰ã§ã™ã€‚ã¾ãŸã€ã“ã®å‹‰å¼·ä¼šã‚’é€šã˜ã¦ã€æ–°ã—ã„ãƒ†ã‚¹ãƒˆæ‰‹æ³•ãŒã‚ã‚Œã°ãã‚Œã‚’çŸ¥ã‚ŠãŸã„ã¨ã„ã†æ€ã„ã‚‚ã‚ã‚Šã¾ã—ãŸã€‚å®Ÿéš›ã«ãƒãƒ£ãƒ¬ãƒ³ã‚¸ã—ãŸå†…å®¹ã¨ãã®çµæœã‚’ãƒ¬ãƒãƒ¼ãƒˆã¨ã—ã¦ã¾ã¨ã‚ã¾ã—ãŸã€‚

## è¦ä»¶ãƒ»ä»•æ§˜

- ãƒ­ã‚°ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã‹ã‚‰ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ãƒšãƒ¼ã‚¸ã€è«‹æ±‚ä¸€è¦§ã€ç™»éŒ²ã€ç·¨é›†ã€å‰Šé™¤ã§ãã‚‹ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³
- Next.js ã®ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ã§ä½œæˆã—ãŸç®¡ç†ç”»é¢ã« 1 ã‹ã‚‰ãƒ†ã‚¹ãƒˆã‚’å°å…¥ã™ã‚‹
- ã©ã“ã‹ 1 ã¤ã®ãƒšãƒ¼ã‚¸ã«ãƒ†ã‚¹ãƒˆã‚’æ›¸ã„ã¦æ­£å¸¸ã«ãƒ‘ã‚¹ãŒã—ã¦ã„ã‚‹ã“ã¨
- è¨­è¨ˆã‚„ãƒ©ã‚¤ãƒ–ãƒ©ãƒªé¸å®šã¯ãƒãƒ¼ãƒ ã§æ±ºã‚ã¦ã‚‚ã‚‰ã†

å®Ÿéš›ã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã¯ã“ã¡ã‚‰ã§ã™ã€‚

![Screen shot of Sort JSON command](/images/sample_app.gif)

## ãƒ¬ãƒãƒ¼ãƒˆ

### Playwright ã§ E2E ãƒ†ã‚¹ãƒˆ

[@bukkan817](https://x.com/intent/user?screen_name=bukkan817), [@hiroshi_mochy](https://x.com/intent/user?screen_name=hiroshi_mochy), [@workspring9029](https://x.com/intent/user?screen_name=workspring9029)

å½“ãƒãƒ¼ãƒ ã§ã¯ã€ã¾ãšã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®æ ¸ã¨ãªã‚‹éƒ¨åˆ†ã«å¯¾ã—ã¦ E2E ãƒ†ã‚¹ãƒˆã‚’å°å…¥ã—ã¾ã—ãŸã€‚ã€Œæ ¸ã¨ãªã‚‹éƒ¨åˆ†ã€ã«ãƒ†ã‚¹ãƒˆç¯„å›²ã‚’é™å®šã™ã‚‹ã“ã¨ã§ã€ã‚¹ã‚³ãƒ¼ãƒ—ã‚’æ˜ç¢ºã«ä¿ã¡ãªãŒã‚‰ã€ä¸»è¦ãªãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ã‚„ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ã‚’ç¢ºå®Ÿã«ã‚«ãƒãƒ¼ã§ãã¾ã™ã€‚ã•ã‚‰ã«ã€å¾ã€…ã«ã‚«ãƒãƒ¬ãƒƒã‚¸ã‚’æ‹¡å¤§ã—ã¤ã¤ã€ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆã‚„ã‚¤ãƒ³ãƒ†ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ†ã‚¹ãƒˆã‚’è¿½åŠ ã—ã¦ã„ãæ–¹é‡ã‚’å–ã£ã¦ã„ã¾ã™ã€‚ã¾ãŸã€Next.js ã®å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã§ã‚‚ã€éåŒæœŸã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®ãƒ†ã‚¹ãƒˆã«ã¯ Jest ã‚„ Vitest ã®ã‚µãƒãƒ¼ãƒˆãŒä¸ååˆ†ãªãŸã‚ã€E2E ãƒ†ã‚¹ãƒˆã®å°å…¥ãŒæ¨å¥¨ã•ã‚Œã¦ã„ã¾ã™ã€‚å€‹äººçš„ã«ã‚‚ã€ã“ã®æ®µéšçš„ãªãƒ†ã‚¹ãƒˆå°å…¥ã¯éå¸¸ã«ç†ã«ã‹ãªã£ãŸã‚¢ãƒ—ãƒ­ãƒ¼ãƒã ã¨æ„Ÿã˜ã¦ã„ã¾ã™ã€‚

> Good to know: Since async Server Components are new to the React ecosystem, Jest currently does not support them. While you can still run unit tests for synchronous Server and Client Components, we recommend using an E2E tests for async components.

https://nextjs.org/docs/app/building-your-application/testing/vitest

ã“ã®ãƒãƒ¼ãƒ ã§ã¯ã€ãƒ­ã‚°ã‚¤ãƒ³ â†’ è«‹æ±‚ä¸€è¦§ â†’ è«‹æ±‚ç™»éŒ² â†’ è«‹æ±‚ä¸€è¦§ã§ç™»éŒ²ã—ãŸãƒ‡ãƒ¼ã‚¿ã‚’ç¢ºèªã™ã‚‹ã¨ã„ã†ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ã‚’ãƒ†ã‚¹ãƒˆã—ã¾ã—ãŸã€‚

#### ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰

:::details playwright.config.ts

```typescript
import { defineConfig, devices } from "@playwright/test";

export default defineConfig({
  testDir: "./tests",
  fullyParallel: true,
  forbidOnly: !!process.env.CI,
  retries: process.env.CI ? 2 : 0,
  workers: process.env.CI ? 1 : undefined,
  reporter: "html",
  use: {
    baseURL: "http://localhost:3000",
    trace: "on-first-retry",
  },
  projects: [
    { name: "setup", testMatch: /.*\.setup\.ts/ }, // ãƒ­ã‚°ã‚¤ãƒ³å‡¦ç†ã‚’è¡Œã†ãƒ†ã‚¹ãƒˆ
    {
      name: "chromium",
      use: {
        ...devices["Desktop Chrome"],
        storageState: "./playwright/.auth/user.json",
      },
      dependencies: ["setup"], // ãƒ­ã‚°ã‚¤ãƒ³å‡¦ç†ã‚’è¡Œã†ãƒ†ã‚¹ãƒˆã‚’å…ˆã«å®Ÿè¡Œã™ã‚‹
    },
    {
      name: "firefox",
      use: {
        ...devices["Desktop Firefox"],
        storageState: "./playwright/.auth/user.json",
      },
      dependencies: ["setup"],
    },
    {
      name: "webkit",
      use: {
        ...devices["Desktop Safari"],
        storageState: "./playwright/.auth/user.json",
      },
      dependencies: ["setup"],
    },
  ],
  webServer: {
    command: "yarn dev",
    url: "http://localhost:3000",
    reuseExistingServer: !process.env.CI,
  },
});
```

:::

:::details auth.setup.ts

```typescript
import { test as setup, expect } from "@playwright/test";

const authFile = "playwright/.auth/user.json";

setup("authenticate", async ({ page }) => {
  await page.goto("http://localhost:3000/");
  await page.getByRole("link", { name: "Log in" }).click();

  // ãƒ­ã‚°ã‚¤ãƒ³
  await expect(
    page.getByRole("heading", { name: "Please log in to continue.", level: 1 })
  ).toBeVisible();
  await page.getByRole("textbox", { name: "Email" }).fill("user@nextmail.com");
  await page.getByRole("textbox", { name: "Password" }).fill("123456");
  await page.getByRole("button", { name: "Log in" }).click();
  await page.waitForURL("/dashboard");

  await page.context().storageState({ path: authFile });
});
```

:::

:::details invoice.test.ts

```typescript
import { test, expect } from "@playwright/test";

test.beforeEach(async ({ page }) => {
  await page.goto("http://localhost:3000/dashboard/invoices");
});

test("è«‹æ±‚æ›¸ã®ç™»éŒ²", async ({ page }) => {
  await expect(
    page.getByRole("heading", { name: "Invoices", level: 1 })
  ).toBeVisible();

  // ãƒ•ã‚©ãƒ¼ãƒ å…¥åŠ›
  await page.getByRole("link", { name: "Create Invoice" }).click();
  await page
    .getByRole("combobox", { name: "Choose customer" })
    .selectOption({ label: "Balazs Orban" });
  await page
    .getByRole("spinbutton", { name: "choose an amount" })
    .fill("123456");
  await page.getByRole("radio", { name: "Pending" }).click();

  // ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡
  await page.getByRole("button", { name: "Create Invoice" }).click();
  await page.waitForURL("/dashboard/invoices");

  // ãƒ†ãƒ¼ãƒ–ãƒ«ã®ä¸€ç•ªä¸Šã«è¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’æ¤œè¨¼
  await expect(
    page.locator("table > tbody > tr:nth-of-type(1) > td:nth-of-type(1)")
  ).toHaveText("Balazs Orban");
  await expect(
    page.locator("table > tbody > tr:nth-of-type(1) > td:nth-of-type(2)")
  ).toHaveText("$123,456.00");
});

test("è«‹æ±‚æ›¸ã®æ›´æ–°", async ({ page }) => {});

test("è«‹æ±‚æ›¸ã®å‰Šé™¤", async ({ page }) => {});
```

:::

#### è©³ç´°

`auth.setup.ts` ã§ã¯èªè¨¼å‡¦ç†ã‚’å®Ÿè¡Œã—ã¦ã„ã¾ã™ã€‚Playwright ã®èªè¨¼æ©Ÿèƒ½ã‚’åˆ©ç”¨ã™ã‚‹ã“ã¨ã§ã€ãƒ†ã‚¹ãƒˆé–‹å§‹æ™‚ã«ä¸€åº¦ã ã‘èªè¨¼å‡¦ç†ã‚’è¡Œã„ã€ä»¥é™ã¯èªè¨¼æ¸ˆã¿ã®çŠ¶æ…‹ã§ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã§ãã¾ã™ã€‚
ä»•çµ„ã¿ã¨ã—ã¦ã€åˆå›ã®èªè¨¼å‡¦ç†ã§ JSON ãƒ•ã‚¡ã‚¤ãƒ«ãŒç”Ÿæˆã•ã‚Œã€ã“ã‚Œã‚’ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ä¿å­˜ã—ã¾ã™ã€‚
å„ãƒ†ã‚¹ãƒˆã§ã¯ãã® JSON ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ–ãƒ©ã‚¦ã‚¶ãŒèª­ã¿è¾¼ã‚€ã“ã¨ã§ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ã‚’å†ç¾ã—ã¾ã™ã€‚

https://playwright.dev/docs/auth

å®Ÿéš›ã«ç”Ÿæˆã•ã‚Œã‚‹ JSON ãƒ•ã‚¡ã‚¤ãƒ«ã«èªè¨¼æƒ…å ±ãŒå…¥ã£ã¦ã„ã‚‹ã“ã¨ãŒç¢ºèªã§ãã¾ã—ãŸã€‚

::: details user.json

```json
{
  "cookies": [
    {
      "name": "authjs.csrf-token",
      "value": "56a3d4c3e91898d8f0610f53dd070b7adc0acece10fcfca1f437d29a99bbb3be%7C7d92311a21d45e8b835ff33a7f982dbc2f8be0d0178c8aae7db2905c36ec7201",
      "domain": "localhost",
      "path": "/",
      "expires": -1,
      "httpOnly": true,
      "secure": false,
      "sameSite": "Lax"
    },
    {
      "name": "authjs.callback-url",
      "value": "http%3A%2F%2Flocalhost%3A3000%2Flogin",
      "domain": "localhost",
      "path": "/",
      "expires": -1,
      "httpOnly": true,
      "secure": false,
      "sameSite": "Lax"
    },
    {
      "name": "authjs.session-token",
      "value": "eyJhbGciOiJkaXIiLCJlbmMiOiJBMjU2R0NNIn0..zrs2p5-TIDyPCAkN.YiiAH40oSCm33pPNTRpbuIjNYzVmYzUYhbiuD9ujgW2e9sQiV25NA1a2OkQl7K8lHuko1t_tebBApQ5O_162k7LaixjBxjdPopG7X5CCdAbMIs_YVHz5cVpy-h_PRWxqmNTqvxSdwiF-wYiUU3yeneMjNMLGiKC9Hs_ogbItV2UGIT4ZqlUUEzkWu_nH2CtwQ-PX14ahWIx8wgDD13NOl0engQ12BJQ.5NBpLiKaSj4TYP14Qk9zJw",
      "domain": "localhost",
      "path": "/",
      "expires": 1736177763.205842,
      "httpOnly": true,
      "secure": false,
      "sameSite": "Lax"
    }
  ],
  "origins": []
}
```

:::

æ•…ã«ã€`invoice.test.ts`ã§ã¯ãƒ­ã‚°ã‚¤ãƒ³å‡¦ç†ã¯ã™ã§ã«å®Œäº†ã—ã¦ãŠã‚Šã€ãƒ­ã‚°ã‚¤ãƒ³å¾Œã®çŠ¶æ…‹ã§ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã—ã¦ã„ã¾ã™ã€‚
ã“ã®ãƒšãƒ¼ã‚¸ã®ãƒ†ã‚¹ãƒˆã§ã¯ã€ç™»éŒ²ã€æ›´æ–°ã€å‰Šé™¤ã¨ã„ã£ãŸæ“ä½œã‚’ãƒ†ã‚¹ãƒˆã§ãã¾ã™ãŒã€å„æ“ä½œã”ã¨ã«ãƒ­ã‚°ã‚¤ãƒ³å‡¦ç†ã‚’è¨˜è¿°ã™ã‚‹å¿…è¦ãŒãªã„ãŸã‚ã€ã‚³ãƒ¼ãƒ‰ã®ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹æ€§ãŒå‘ä¸Šã—ã¾ã™ã€‚

ãƒ†ã‚¹ãƒˆãŒé€šã‚‹ã“ã¨ãŒç¢ºèªã§ãã¾ã—ãŸï¼

```bash
yarn test
yarn run v1.22.22
$ playwright test

Running 10 tests using 8 workers
  10 passed (5.8s)

To open last HTML report run:

  yarn playwright show-report

âœ¨  Done in 6.25s.
```

### Vitest + React Testing Library ã«ã‚ˆã‚‹ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆãƒ†ã‚¹ãƒˆ

[@engineerYodaka](https://x.com/engineerYodaka), [@ask_nugey](https://x.com/ask_nugey), [@tezmasatoo](https://x.com/tezmasatoo)

ã“ã®ãƒãƒ¼ãƒ ã§ã¯ã€Vitest ã¨ React Testing Library ã‚’åˆ©ç”¨ã—ã¦ Form ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆã‚’å°å…¥ã—ã¾ã—ãŸã€‚Server Actions ã‚’åˆ©ç”¨ã—ã¦ã„ã‚‹ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®ãƒ†ã‚¹ãƒˆã‚’ç­†è€…ã‚‚çµŒé¨“ã—ãŸã“ã¨ãŒãªã‹ã£ãŸã®ã§éå¸¸ã«å‹‰å¼·ã«ãªã‚Šã¾ã—ãŸã€‚
ä»¥ä¸‹ã€è«‹æ±‚ç™»éŒ²ã§ãã‚‹ Form ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã§ã™ã€‚

::: details Form.tsx

```typescript
"use client";

import { CustomerField } from "@/app/lib/definitions";
import Link from "next/link";
import {
  CheckIcon,
  ClockIcon,
  CurrencyDollarIcon,
  UserCircleIcon,
} from "@heroicons/react/24/outline";
import { Button } from "@/app/ui/button";
import { createInvoice } from "@/app/lib/actions";
import { useFormState } from "react-dom";

export default function Form({ customers }: { customers: CustomerField[] }) {
  const initialState = { message: "", errors: {} };
  const [state, dispatch] = useFormState(createInvoice, initialState);

  return (
    <form action={dispatch}>
      <div className="rounded-md bg-gray-50 p-4 md:p-6">
        {/* Customer Name */}
        <div className="mb-4">
          <label htmlFor="customer" className="mb-2 block text-sm font-medium">
            Choose customer
          </label>
          <div className="relative">
            <select
              id="customer"
              name="customerId"
              className="peer block w-full rounded-md border border-gray-200 py-2 pl-10 text-sm outline-2 placeholder:text-gray-500"
              defaultValue=""
              aria-describedby="customer-error"
            >
              <option value="" disabled>
                Select a customer
              </option>
              {customers.map((customer) => (
                <option key={customer.id} value={customer.id}>
                  {customer.name}
                </option>
              ))}
            </select>
            <UserCircleIcon className="pointer-events-none absolute left-3 top-1/2 h-[18px] w-[18px] -translate-y-1/2 text-gray-500" />
          </div>
          <div id="customer-error" aria-live="polite" aria-atomic="true">
            {state.errors?.customerId &&
              state.errors.customerId.map((error: string) => (
                <p className="mt-2 text-sm text-red-500" key={error}>
                  {error}
                </p>
              ))}
          </div>
        </div>

        {/* Invoice Amount */}
        <div className="mb-4">
          <label htmlFor="amount" className="mb-2 block text-sm font-medium">
            Choose an amount
          </label>
          <div className="relative mt-2 rounded-md">
            <div className="relative">
              <input
                id="amount"
                name="amount"
                type="number"
                step="0.01"
                placeholder="Enter USD amount"
                aria-describedby="amount-error"
                className="peer block w-full rounded-md border border-gray-200 py-2 pl-10 text-sm outline-2 placeholder:text-gray-500"
              />
              <CurrencyDollarIcon className="pointer-events-none absolute left-3 top-1/2 h-[18px] w-[18px] -translate-y-1/2 text-gray-500 peer-focus:text-gray-900" />
            </div>
            <div id="amount-error" aria-live="polite" aria-atomic="true">
              {state.errors?.amount &&
                state.errors.amount.map((error: string) => (
                  <p className="mt-2 text-sm text-red-500" key={error}>
                    {error}
                  </p>
                ))}
            </div>
          </div>
        </div>

        {/* Invoice Status */}
        <fieldset>
          <legend className="mb-2 block text-sm font-medium">
            Set the invoice status
          </legend>
          <div className="rounded-md border border-gray-200 bg-white px-[14px] py-3">
            <div className="flex gap-4">
              <div className="flex items-center">
                <input
                  id="pending"
                  name="status"
                  type="radio"
                  value="pending"
                  aria-describedby="status-error"
                  className="h-4 w-4 border-gray-300 bg-gray-100 text-gray-600 focus:ring-2 focus:ring-gray-500 dark:border-gray-600 dark:bg-gray-700 dark:ring-offset-gray-800 dark:focus:ring-gray-600"
                />
                <label
                  htmlFor="pending"
                  className="ml-2 flex items-center gap-1.5 rounded-full bg-gray-100 px-3 py-1.5 text-xs font-medium text-gray-600 dark:text-gray-300"
                >
                  Pending <ClockIcon className="h-4 w-4" />
                </label>
              </div>
              <div className="flex items-center">
                <input
                  id="paid"
                  name="status"
                  type="radio"
                  value="paid"
                  aria-describedby="status-error"
                  className="h-4 w-4 border-gray-300 bg-gray-100 text-gray-600 focus:ring-2 focus:ring-gray-500 dark:border-gray-600 dark:bg-gray-700 dark:ring-offset-gray-800 dark:focus:ring-gray-600"
                />
                <label
                  htmlFor="paid"
                  className="ml-2 flex items-center gap-1.5 rounded-full bg-green-500 px-3 py-1.5 text-xs font-medium text-white dark:text-gray-300"
                >
                  Paid <CheckIcon className="h-4 w-4" />
                </label>
              </div>
            </div>
            <div id="status-error" aria-live="polite" aria-atomic="true">
              {state.errors?.status &&
                state.errors.status.map((error: string) => (
                  <p className="mt-2 text-sm text-red-500" key={error}>
                    {error}
                  </p>
                ))}
            </div>
          </div>
        </fieldset>
      </div>
      <div className="mt-6 flex justify-end gap-4">
        <Link
          href="/dashboard/invoices"
          className="flex h-10 items-center rounded-lg bg-gray-100 px-4 text-sm font-medium text-gray-600 transition-colors hover:bg-gray-200"
        >
          Cancel
        </Link>
        <Button type="submit">Create Invoice</Button>
      </div>
    </form>
  );
}
```

:::

::: details Form.action.ts

```typescript
import { sql } from "@vercel/postgres";
import { redirect } from "next/navigation";
import { z } from "zod";

const FormSchema = z.object({
  id: z.string(),
  customerId: z.string({
    invalid_type_error: "Please select a customer.",
  }),
  amount: z.coerce
    .number()
    .gt(0, { message: "Please enter an amount greater than $0." }),
  status: z.enum(["pending", "paid"], {
    invalid_type_error: "Please select an invoice status.",
  }),
  date: z.string(),
});

const InvoiceSchema = FormSchema.omit({ id: true, date: true });

export type State = {
  errors?: {
    customerId?: string[];
    amount?: string[];
    status?: string[];
  };
  message?: string | null;
};

export async function createInvoice(prevState: State, formData: FormData) {
  const validateFields = InvoiceSchema.safeParse({
    customerId: formData.get("customerId"),
    amount: formData.get("amount"),
    status: formData.get("status"),
  });

  if (!validateFields.success) {
    return {
      errors: validateFields.error.flatten().fieldErrors,
      message: "Missing Fields. Failed to Create Invoice.",
    };
  }
  const { customerId, amount, status } = validateFields.data;
  const amountInCents = amount * 100;
  const date = new Date().toISOString().split("T")[0];

  try {
    await sql`
      INSERT INTO invoices (customer_id, amount, status, date)
      VALUES (${customerId}, ${amountInCents}, ${status}, ${date})
      `;

    redirect("/dashboard/invoices");
  } catch (error) {
    return { massage: "Something went wrong", error };
  }
}
```

:::

Form ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®è©³ç´°ã¨ã—ã¦ã¯ã€å…¥åŠ›æ¬„ã«å€¤ã‚’å…¥åŠ›ã—ã¦ä½œæˆãƒœã‚¿ãƒ³ã‚’æŠ¼ä¸‹ã™ã‚‹ã¨ã€è«‹æ±‚ãŒç™»éŒ²ã•ã‚Œã€å€¤ã«å•é¡ŒãŒã‚ã‚Œã°ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã¨ã„ã†ã‚‚ã®ã§ã™ã€‚Form.action.ts ã¯ Form ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã§å—ã‘å–ã£ãŸå€¤ã‚’ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã«ã‹ã‘ã¦å•é¡Œãªã‘ã‚Œã°è«‹æ±‚ã‚’ DB ã«ç™»éŒ²ã™ã‚‹å‡¦ç†ã‚’ã—ã¦ã„ã‚‹ Server Actions ã§ã™ã€‚ã¾ãŸã€ãƒ†ã‚¹ãƒˆã‚’è¨˜è¼‰ã—ã¦ã„ãã†ã¡ã«ã€èª²é¡ŒãŒä¸ŠãŒã£ã¦ãã¾ã—ãŸã€‚

#### useFormState ã®ã‚¨ãƒ©ãƒ¼

Form ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã§ã¯ã€useFormState ã‚’åˆ©ç”¨ã—ã¦ã„ã¾ã™ã€‚useFormState ã§ã¯ã€æ¸¡ã•ã‚ŒãŸã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã®çµæœã«åŸºã¥ã state ã‚’æ›´æ–°ã™ã‚‹ hook ã§ã™ã€‚
useFormState ã¨ Server Actions ã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹ãƒ†ã‚¹ãƒˆã§ä»¥ä¸‹ã€ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚

```bash
TypeError: (0 , _reactdom.useFormState) is not a function or its return value is not iterable.
```

stack overflow ã«ã‚‚åŒã˜ã‚ˆã†ã«æ‚©ã‚“ã§ã„ã‚‹äººãŒã„ã¾ã—ãŸã€‚

https://stackoverflow.com/questions/78136654/testing-a-next-js-component-with-useformstate-from-react-dom-or-alternatives

ã¾ãŸã€useFormState è‡ªä½“ã‚’ mock ã«ã™ã‚‹ã¨ã‚¨ãƒ©ãƒ¼ãŒè§£æ¶ˆã—ãã†ãªè¨˜äº‹ã‚‚ç™ºè¦‹ã—ã¾ã—ãŸã€‚

https://stackoverflow.com/questions/77705420/jest-next14-useformstate-typeerror-0-reactdom-useformstate-is-not-a-functi

ã•ã‚‰ã«èª¿ã¹ã¦ã„ãã¨ã€Next.js ã® issue ã«ã‚³ãƒ¡ãƒ³ãƒˆãŒã‚ã‚Šã¾ã—ãŸã€‚

> I had some discussions regarding other problems with the Testing library and NextJS some weeks ago in their repo. They suggested that there's a mismatched version between NextJS envs and test envs. Meanwhile Next is using React Canary, probably the test environment is still in React 18.2. That could explain as well this possible issue. React 19 should solve this issue (if I am not wrong).

https://github.com/vercel/next.js/issues/54757#issuecomment-2015168447

ã“ã®ã‚³ãƒ¡ãƒ³ãƒˆã«ã‚ˆã‚‹ã¨ã€Next.js ã¨ React Testing Library ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãŒä¸€è‡´ã—ã¦ã„ãªã„ã“ã¨ãŒåŸå› ã§ã‚ã‚Šãã†ã§ã™ã€‚
ã»ã‚“ã¾ã‹ã¨æ€ã„ãªãŒã‚‰ã€React19 ã«ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã™ã‚‹å¿…è¦ãŒã‚ã‚Šãã†ãªã®ã§ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã—ã¦ã¿ã¾ã—ãŸã€‚(ã“ã“ã‹ã‚‰ã¯ç­†è€…ãŒã‚„ã£ã¦ã¿ã¾ã—ãŸ)

```diff js:package.json
- "react": "^18.2.0",
- "react-dom": "^18.2.0",
- "next": "^14.0.0",
- "@types/react": "^18.2.21",
- "@types/react-dom": "^18.2.14",
+ "react": "^19.0.0",
+ "react-dom": "^19.0.0",
+ "next": "^15.0.4",
+ "@types/react": "^19.0.1",
+ "@types/react-dom": "^19.0.1",
```

React 19 ã‹ã‚‰ã¯ useFormState ã‹ã‚‰ useActinonState ã«å¤‰æ›´ã•ã‚Œã¦ã„ã‚‹ãŸã‚è©²å½“ç®‡æ‰€ã‚’ä¿®æ­£ã—ã¾ã™ã€‚

https://ja.react.dev/reference/react/useActionState

```diff js:From.tsx
- import { useFormState } from "react-dom";
+ import { useActionState } from "react";

- const [state, dispatch] = useFormState(createInvoice, initialState);
+ const [state, dispatch] = useActionState(createInvoice, initialState);
```

ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã™ã‚‹ã¨ã‚¨ãƒ©ãƒ¼ãŒè§£æ¶ˆã—ã¾ã—ãŸã€‚

```bash
yarn test Form.test.tsx
yarn run v1.22.22
$ vitest Form.test.tsx
The CJS build of Vite's Node API is deprecated. See https://vite.dev/guide/troubleshooting.html#vite-cjs-node-api-deprecated for more details.

 âœ“ app/ui/invoices/Form.test.tsx (1)
   âœ“ CreateForm (1)
     âœ“ æ­£å¸¸ãªå€¤ã§ãƒ•ã‚©ãƒ¼ãƒ ã‚’ã‚µãƒ–ãƒŸãƒƒãƒˆã—ãŸå ´åˆã€createInvoiceãŒå‘¼ã³å‡ºã•ã‚Œã‚‹

 Test Files  1 passed (1)
      Tests  1 passed (1)
   Start at  00:54:11
   Duration  764ms (transform 36ms, setup 107ms, collect 96ms, tests 91ms, environment 187ms, prepare 32ms)
```

#### ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰

::: details Form.test.tsx

```typescript
import { render, screen } from "@testing-library/react";
import userEvent from "@testing-library/user-event";
import { createInvoice } from "./form-action";
import Form from "./create-form";

const mockCustomers = [
  {
    id: "1",
    name: "John Doe",
  },
  {
    id: "2",
    name: "Hannah Montana",
  },
];

// Server Action ã‚’ãƒ¢ãƒƒã‚¯ã™ã‚‹
vi.mock("./form.action", () => ({
  createInvoice: vi.fn().mockResolvedValue({
    message: "",
    errors: [],
  }),
}));

describe("CreateForm", () => {
  test("æ­£å¸¸ãªå€¤ã§ãƒ•ã‚©ãƒ¼ãƒ ã‚’ã‚µãƒ–ãƒŸãƒƒãƒˆã—ãŸå ´åˆã€createInvoiceãŒå‘¼ã³å‡ºã•ã‚Œã‚‹", async () => {
    render(<Form customers={mockCustomers} />);

    const selectBox = screen.getByRole("combobox");
    await userEvent.selectOptions(selectBox, "John Doe");
    expect(selectBox).toHaveValue("1");

    const input = screen.getByRole("spinbutton");
    await userEvent.type(input, "100");
    expect(input).toHaveValue(100);

    const radios = screen.getAllByRole("radio");
    await userEvent.click(radios[0]);
    expect(radios[0]).toBeChecked();

    const submitButton = screen.getByRole("button", { name: "Create Invoice" });
    await userEvent.click(submitButton);

    expect(createInvoice).toHaveBeenCalled();
  });
});
```

:::

::: details Form.action.test.ts

```typescript
import { sql } from "@vercel/postgres";
import { createInvoice } from "./form";
import { vi } from "vitest";

const { redirectMock } = vi.hoisted(() => {
  return { redirectMock: vi.fn() };
});

vi.mock("next/navigation", () => ({
  redirect: redirectMock,
}));

vi.mock("@vercel/postgres", () => ({
  sql: vi.fn(),
}));

describe("createInvoice", () => {
  it("æ­£å¸¸ã«è«‹æ±‚ãŒä½œæˆã•ã‚Œã‚‹å ´åˆ", async () => {
    const formData = new FormData();
    formData.set("customerId", "1");
    formData.set("amount", "10000");
    formData.set("status", "paid");

    await createInvoice({}, formData);

    const [[queryParts, customerId, amountInCents, status, date]] = (
      sql as unknown as { mock: { calls: any[][] } }
    ).mock.calls;

    const queryString = queryParts.join(" ");
    expect(queryString).toContain(
      "INSERT INTO invoices (customer_id, amount, status, date)"
    );
    expect(customerId).toBe("1");
    expect(amountInCents).toBe(1000000); // 10000 * 100
    expect(status).toBe("paid");
    expect(date).toMatch(/^\d{4}-\d{2}-\d{2}$/);

    expect(redirectMock).toHaveBeenCalledWith("/dashboard/invoices");
  });

  it("ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼ã®å ´åˆã€ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¿”ã™", async () => {
    const formData = new FormData();
    formData.set("customerId", "");
    formData.set("amount", "-100");
    formData.set("status", "invalid");

    const result = await createInvoice({}, formData);

    expect(result).toEqual({
      errors: expect.any(Object),
      message: "Missing Fields. Failed to Create Invoice.",
    });
  });
});
```

:::

#### è©³ç´°

`Form.test.tsx` ã§ã¯ã€Form ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã—ãŸã†ãˆã§ã€ãƒ•ã‚©ãƒ¼ãƒ ã®å…¥åŠ›æ¬„ã«å€¤ã‚’å…¥åŠ›ã—ã€é€ä¿¡ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸéš›ã« createInvoice ãŒå‘¼ã³å‡ºã•ã‚Œã‚‹ã“ã¨ã‚’ãƒ†ã‚¹ãƒˆã—ã¦ã„ã¾ã™ã€‚Form ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®è²¬å‹™ã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå…¥åŠ›ã—ãŸãƒ‡ãƒ¼ã‚¿ã‚’æ­£ã—ãå–å¾—ã—ã€ã‚µãƒ¼ãƒãƒ¼ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã«æ¸¡ã™ã“ã¨ã«é™å®šã•ã‚Œã¾ã™ã€‚ãã®ãŸã‚ã€createInvoice ã®å†…éƒ¨å‡¦ç†ï¼ˆã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ãƒ­ã‚¸ãƒƒã‚¯ï¼‰ã«ã¤ã„ã¦ã¯ `Form.action.test.ts` ã§åˆ¥é€”ãƒ†ã‚¹ãƒˆã‚’è¡Œã„ã¾ã™ã€‚

ã‚µãƒ¼ãƒãƒ¼ã‚¢ã‚¯ã‚·ãƒ§ãƒ³å‘¼ã³å‡ºã—ã¯ vi.mock ã‚’ç”¨ã„ã¦ãƒ¢ãƒƒã‚¯åŒ–ã—ã¦ãŠã‚Šã€ä»¥ä¸‹ã®ã‚ˆã†ã«è¨­å®šã—ã¦ã„ã¾ã™ã€‚

```typescript
vi.mock("./form.action", () => ({
  createInvoice: vi.fn().mockResolvedValue({
    message: "",
    errors: [],
  }),
}));
```

ä¸€æ–¹ã€`Form.action.test.ts` ã§ã¯ã€ã‚µãƒ¼ãƒãƒ¼ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆcreateInvoiceï¼‰è‡ªä½“ã®ãƒ†ã‚¹ãƒˆã‚’è¡Œã„ã¾ã™ã€‚ã“ã“ã§ã¯ã€å®Ÿéš›ã«å®Ÿè¡Œã•ã‚Œã‚‹ SQL ã‚¯ã‚¨ãƒªã‚„ãã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒå¦¥å½“ã‹ã€ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿæ™‚ã«é©åˆ‡ãªã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒè¿”ã£ã¦ãã‚‹ã‹ã‚’æ¤œè¨¼ã—ã¾ã™ã€‚ã¾ãŸã€ã‚µãƒ¼ãƒãƒ¼å´ã§ redirect ãŒå®Ÿè¡Œã•ã‚Œã‚‹å ´åˆã€ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆå…ˆã® URL ãŒæ­£ã—ãè¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹ã‚‚ãƒ†ã‚¹ãƒˆã—ã€ç•°ãªã‚‹å€¤ãŒæ¸¡ã•ã‚ŒãŸå ´åˆã¯ãƒ†ã‚¹ãƒˆãŒå¤±æ•—ã™ã‚‹ã“ã¨ã‚’ç¢ºèªã§ãã¾ã™ã€‚

```typescript
 FAIL  app/ui/invoices/action.test.ts > createInvoice > æ­£å¸¸ã«è«‹æ±‚ãŒä½œæˆã•ã‚Œã‚‹å ´åˆ
AssertionError: expected "spy" to be called with arguments: [ '/dashboard/invoice' ]

Received:

  1st spy call:

  Array [
-   "/dashboard/invoice",
+   "/dashboard/invoices",
  ]


Number of calls: 1

 â¯ app/ui/invoices/action.test.ts:38:26
```

ã“ã®ã‚ˆã†ãªå½¢ã§ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆã‚’åˆ†å‰²ã™ã‚‹ã“ã¨ã§ã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã¨ã‚µãƒ¼ãƒãƒ¼ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãŒãã‚Œãã‚Œå›ºæœ‰ã®è²¬å‹™ã«å¯¾ã—ã¦æ­£ã—ãæ©Ÿèƒ½ã—ã¦ã„ã‚‹ã‹ã‚’æ‹…ä¿ã§ãã¾ã™ã€‚
å‹å®šç¾©ã‚„ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰ã®è¨˜è¿°æ–¹æ³•ã«ã¯ã€ã¾ã æ”¹å–„ã®ä½™åœ°ãŒæ®‹ã•ã‚Œã¦ã„ã¾ã™ãŒã€ç¾çŠ¶ã§ã‚‚æœ€ä½é™ã®å“è³ªã¯ç¢ºä¿ã§ãã¦ã„ã‚‹ã¨è€ƒãˆã‚‰ã‚Œã¾ã™ã€‚
æœ€å¾Œã«ã€ã™ã¹ã¦ã®ãƒ†ã‚¹ãƒˆãŒæˆåŠŸã™ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¾ã—ãŸã€‚

```bash
yarn test
yarn run v1.22.22
$ vitest run
The CJS build of Vite's Node API is deprecated. See https://vite.dev/guide/troubleshooting.html#vite-cjs-node-api-deprecated for more details.

 RUN  v2.1.8 /Users/shogofukami/Documents/Next.js13-learn

 âœ“ app/ui/invoices/form.action.test.ts (2)
 âœ“ app/ui/invoices/form.test.tsx (1)

 Test Files  2 passed (2)
      Tests  3 passed (3)
   Start at  13:07:44
   Duration  755ms (transform 46ms, setup 255ms, collect 127ms, tests 95ms, environment 441ms, prepare 62ms)

âœ¨  Done in 1.24s.
```

### Vitest ã«ã‚ˆã‚‹ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãƒ†ã‚¹ãƒˆ

[@yossydev](https://x.com/yossydev), [@yasushi_cohi](https://x.com/yasushi_cohi), tatsuya.n

ã“ã¡ã‚‰ã®ãƒãƒ¼ãƒ ã§ã¯ã€Vitest ã‚’åˆ©ç”¨ã—ã¦ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã®ãƒ†ã‚¹ãƒˆã€Storybook å°å…¥ã€E2E ãƒ†ã‚¹ãƒˆã®å°å…¥ã«ãƒãƒ£ãƒ¬ãƒ³ã‚¸ã—ã¦ã„ã¾ã™ãŒã€ä¸€éƒ¨å®Œæˆã—ã¦ã„ãªã„éƒ¨åˆ†ãŒã‚ã‚Šã€ã“ã“ã§ã¯ Vitest ã‚’åˆ©ç”¨ã—ãŸãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãƒ†ã‚¹ãƒˆã®ãƒãƒ£ãƒ¬ãƒ³ã‚¸ã‚’ç´¹ä»‹ã—ã¾ã™ã€‚

::: details data.ts

```typescript
export async function fetchCardData() {
  try {
    const invoiceCountPromise = sql`SELECT COUNT(*) FROM invoices`;
    const customerCountPromise = sql`SELECT COUNT(*) FROM customers`;
    const invoiceStatusPromise = sql`SELECT
         SUM(CASE WHEN status = 'paid' THEN amount ELSE 0 END) AS "paid",
         SUM(CASE WHEN status = 'pending' THEN amount ELSE 0 END) AS "pending"
         FROM invoices`;

    const data = await Promise.all([
      invoiceCountPromise,
      customerCountPromise,
      invoiceStatusPromise,
    ]);

    const numberOfInvoices = Number(data[0].rows[0].count ?? "0");
    const numberOfCustomers = Number(data[1].rows[0].count ?? "0");
    const totalPaidInvoices = formatCurrency(data[2].rows[0].paid ?? "0");
    const totalPendingInvoices = formatCurrency(data[2].rows[0].pending ?? "0");

    return {
      numberOfInvoices,
      numberOfCustomers,
      totalPaidInvoices,
      totalPendingInvoices,
    };
  } catch (error) {
    console.error("Database Error:", error);
    throw new Error("Failed to fetch revenue data.");
  }
}
```

:::

fetchCardData é–¢æ•°å†…éƒ¨ã§ç›´æ¥ sql ã‚¯ã‚¨ãƒªã‚’å‘¼ã³å‡ºã—ã¦ã„ã¾ã—ãŸã€‚ãã®ãŸã‚ã€ãƒ†ã‚¹ãƒˆç’°å¢ƒã§ã¯å®Ÿéš›ã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šã‚„ SQL å®Ÿè¡Œéƒ¨åˆ†ã‚’ãƒ¢ãƒƒã‚¯ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã€ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰ãŒè¤‡é›‘ã«ãªã‚ŠãŒã¡ã§ã—ãŸã€‚

::: details ä¿®æ­£å¾Œã® data.ts

```typescript
interface QueryResult<T> {
  rows: T[];
}

interface CountResult {
  count: number;
}

interface InvoiceStatusResult {
  paid: number;
  pending: number;
}

export async function fetchCardData(
  invoiceCountQuery: Promise<QueryResult<CountResult>>,
  customerCountQuery: Promise<QueryResult<CountResult>>,
  invoiceStatusQuery: Promise<QueryResult<InvoiceStatusResult>>
): Promise<{
  numberOfCustomers: number;
  numberOfInvoices: number;
  totalPaidInvoices: string;
  totalPendingInvoices: string;
}> {
  try {
    const [invoiceCount, customerCount, invoiceStatus] = await Promise.all([
      invoiceCountQuery,
      customerCountQuery,
      invoiceStatusQuery,
    ]);

    const numberOfInvoices = Number(invoiceCount.rows[0].count ?? "0");
    const numberOfCustomers = Number(customerCount.rows[0].count ?? "0");
    const totalPaidInvoices = formatCurrency(invoiceStatus.rows[0].paid ?? "0");
    const totalPendingInvoices = formatCurrency(
      invoiceStatus.rows[0].pending ?? "0"
    );

    return {
      numberOfCustomers,
      numberOfInvoices,
      totalPaidInvoices,
      totalPendingInvoices,
    };
  } catch (error) {
    throw new Error("Failed to card data.");
  }
}
```

:::

DI å¯¾å¿œå¾Œã¯ã€fetchCardData é–¢æ•°ãŒ invoiceCountQuery, customerCountQuery, invoiceStatusQuery ã¨ã„ã£ãŸã‚¯ã‚¨ãƒªçµæœã® Promise ã‚’å¼•æ•°ã¨ã—ã¦å—ã‘å–ã‚‹ã‚ˆã†ã«å¤‰æ›´ã•ã‚Œã¦ã„ã¾ã™ã€‚ã“ã®å¤‰æ›´ã«ã‚ˆã‚Šã€ãƒ†ã‚¹ãƒˆæ™‚ã«ã¯ã€å®Ÿéš›ã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šã‚„ SQL ã‚’å®Ÿè¡Œã›ãšã«ã€ä»»æ„ã®ãƒ¢ãƒƒã‚¯ãƒ‡ãƒ¼ã‚¿ã‚’ fetchCardData ã«æ³¨å…¥ã™ã‚‹ã“ã¨ãŒå¯èƒ½ã«ãªã‚Šã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ç’°å¢ƒã‚„å¤–éƒ¨ãƒªã‚½ãƒ¼ã‚¹ã«ä¾å­˜ã›ãšã€ç´”ç²‹ã«é–¢æ•°ãƒ­ã‚¸ãƒƒã‚¯ã‚’ãƒ†ã‚¹ãƒˆã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

#### ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰

::: details data.test.ts

```typescript
import { expect, test, describe } from "vitest";
import { fetchCardData } from "./data";
import { formatCurrency } from "./utils";

// SQLã‚¯ã‚¨ãƒªã®ä»£ã‚ã‚Šã®ãƒ¢ãƒƒã‚¯ãƒ‡ãƒ¼ã‚¿
const mockSqlQueries = {
  invoiceCount: Promise.resolve({
    rows: [{ count: 1 }],
  }),
  customerCount: Promise.resolve({
    rows: [{ count: 1 }],
  }),
  invoiceStatus: Promise.resolve({
    rows: [{ paid: 549932, pending: 1000251164 }],
  }),
};

describe("fetchCardData", () => {
  test("æ­£ã—ããƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¦è¿”ã™ã“ã¨", async () => {
    const result = await fetchCardData(
      mockSqlQueries.invoiceCount,
      mockSqlQueries.customerCount,
      mockSqlQueries.invoiceStatus
    );

    expect(result).toStrictEqual({
      numberOfCustomers: 1,
      numberOfInvoices: 1,
      totalPaidInvoices: formatCurrency(549932),
      totalPendingInvoices: formatCurrency(1000251164),
    });
  });
});
```

:::

#### è©³ç´°

ã“ã®ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰ã§ã¯ã€fetchCardData é–¢æ•°ã«æ¸¡ã•ã‚Œã‚‹ SQL ã‚¯ã‚¨ãƒªã®çµæœã‚’ãƒ¢ãƒƒã‚¯åŒ–ã—ã¦ã„ã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šã‚„ SQL å®Ÿè¡Œã‚’è¡Œã‚ãšã«ã€ãƒ†ã‚¹ãƒˆç’°å¢ƒã§ãƒ‡ãƒ¼ã‚¿ã‚’æ³¨å…¥ã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚ã“ã‚Œã«ã‚ˆã‚Šã€fetchCardData é–¢æ•°ã®ãƒ†ã‚¹ãƒˆãŒã‚ˆã‚Šç°¡æ½”ã‹ã¤ç‹¬ç«‹æ€§ãŒé«˜ããªã‚Šã¾ã—ãŸã€‚fetchCardData ã‚’å‘¼ã³å‡ºã—ã¦ã€çµæœãŒæ­£å¸¸ã«è¿”å´ã•ã‚Œã‚‹ã‚·ãƒ³ãƒ—ãƒ«ãªãƒ†ã‚¹ãƒˆã«ãªã‚Šã¾ã—ãŸã€‚

ãƒ†ã‚¹ãƒˆãŒé€šã‚‹äº‹ã‚’ç¢ºèªã§ãã¾ã—ãŸï¼

```bash
yarn test
yarn run v1.22.22
$ vitest

 DEV  v2.1.6 /Users/shogofukami/Documents/Next.js13-learn

 âœ“ |0| app/lib/data.test.ts (1)
   âœ“ fetchCardData (1)
     âœ“ æ­£ã—ããƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¦è¿”ã™ã“ã¨

 Test Files  1 passed (1)
      Tests  1 passed (1)
   Start at  00:28:19
   Duration  1.21s (transform 0ms, setup 0ms, collect 21ms, tests 7ms, environment 0ms, prepare 159ms)

 PASS  Waiting for file changes...
```

## ã¾ã¨ã‚

ä»Šå›ã”å‚åŠ ã„ãŸã ã„ãŸçš†ã•ã¾ã€èª ã«ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã—ãŸã€‚
ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã‚„ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰ã®æ›¸ãæ–¹ã«ã¯ã¾ã ã¾ã æ”¹å–„ã®ä½™åœ°ãŒã‚ã‚Šã¾ã™ãŒã€å®Ÿéš›ã«ä»–ç¤¾ã®ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã¨ä¸€ç·’ã«ã‚³ãƒ¼ãƒ‰ã‚’æ›¸ããªãŒã‚‰è­°è«–ã§ãã‚‹æ©Ÿä¼šã¯è²´é‡ã§ã€ã¨ã¦ã‚‚æœ‰æ„ç¾©ãªæ™‚é–“ã¨ãªã‚Šã¾ã—ãŸã€‚

æ¥å¹´åº¦ã‚‚ã“ã®ã‚¤ãƒ™ãƒ³ãƒˆã¯ç¶™ç¶šã—ã¦ã„ãäºˆå®šã§ã™ã®ã§ã€ãœã²ã¾ãŸã”å‚åŠ ãã ã•ã„ï¼
