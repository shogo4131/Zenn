---
title: "App Routerで学ぶテスト実践会のレポート"
emoji: "📝"
type: "tech"
topics: ["Nextjs", "AppRouter", "frontend", "Tech"]
published: false
---

## はじめに

先日(2024/11/30)に「App Router で学ぶテスト実践会」を主催しました。

https://devguil.connpass.com/event/336183/

この勉強会を開催したきっかけは、筆者含め App Router のテストに関して情報が少なく、他社のエンジニアがテストをどのように行っているかを知りたいという思いがあったからです。また、この勉強会を通じて、新しいテスト手法があればそれを知りたいという思いもありました。実際にチャレンジした内容とその結果をレポートとしてまとめました。

## 要件・仕様

- ログインページからダッシュボードページ、請求一覧、登録、編集、削除できるアプリケーション
- Next.js のチュートリアルで作成した管理画面に 1 からテストを導入する
- どこか 1 つのページにテストを書いて正常にパスがしていること
- 設計やライブラリ選定はチームで決めてもらう

実際のアプリケーションはこちらです。

![Screen shot of Sort JSON command](/images/sample_app.gif)

## レポート

### Playwright で E2E テスト

[@bukkan817](https://x.com/intent/user?screen_name=bukkan817), [@hiroshi_mochy](https://x.com/intent/user?screen_name=hiroshi_mochy), [@workspring9029](https://x.com/intent/user?screen_name=workspring9029)

当チームでは、まずアプリケーションの核となる部分に対して E2E テストを導入しました。「核となる部分」にテスト範囲を限定することで、スコープを明確に保ちながら、主要なユーザーストーリーやビジネスロジックを確実にカバーできます。さらに、徐々にカバレッジを拡大しつつ、ユニットテストやインテグレーションテストを追加していく方針を取っています。また、Next.js の公式ドキュメントでも、非同期コンポーネントのテストには Jest や Vitest のサポートが不十分なため、E2E テストの導入が推奨されています。個人的にも、この段階的なテスト導入は非常に理にかなったアプローチだと感じています。

> Good to know: Since async Server Components are new to the React ecosystem, Jest currently does not support them. While you can still run unit tests for synchronous Server and Client Components, we recommend using an E2E tests for async components.

https://nextjs.org/docs/app/building-your-application/testing/vitest

このチームでは、ログイン → 請求一覧 → 請求登録 → 請求一覧で登録したデータを確認するというユーザーストーリーをテストしました。

#### テストコード

:::details playwright.config.ts

```typescript
import { defineConfig, devices } from "@playwright/test";

export default defineConfig({
  testDir: "./tests",
  fullyParallel: true,
  forbidOnly: !!process.env.CI,
  retries: process.env.CI ? 2 : 0,
  workers: process.env.CI ? 1 : undefined,
  reporter: "html",
  use: {
    baseURL: "http://localhost:3000",
    trace: "on-first-retry",
  },
  projects: [
    { name: "setup", testMatch: /.*\.setup\.ts/ }, // ログイン処理を行うテスト
    {
      name: "chromium",
      use: {
        ...devices["Desktop Chrome"],
        storageState: "./playwright/.auth/user.json",
      },
      dependencies: ["setup"], // ログイン処理を行うテストを先に実行する
    },
    {
      name: "firefox",
      use: {
        ...devices["Desktop Firefox"],
        storageState: "./playwright/.auth/user.json",
      },
      dependencies: ["setup"],
    },
    {
      name: "webkit",
      use: {
        ...devices["Desktop Safari"],
        storageState: "./playwright/.auth/user.json",
      },
      dependencies: ["setup"],
    },
  ],
  webServer: {
    command: "yarn dev",
    url: "http://localhost:3000",
    reuseExistingServer: !process.env.CI,
  },
});
```

:::

:::details auth.setup.ts

```typescript
import { test as setup, expect } from "@playwright/test";

const authFile = "playwright/.auth/user.json";

setup("authenticate", async ({ page }) => {
  await page.goto("http://localhost:3000/");
  await page.getByRole("link", { name: "Log in" }).click();

  // ログイン
  await expect(
    page.getByRole("heading", { name: "Please log in to continue.", level: 1 })
  ).toBeVisible();
  await page.getByRole("textbox", { name: "Email" }).fill("user@nextmail.com");
  await page.getByRole("textbox", { name: "Password" }).fill("123456");
  await page.getByRole("button", { name: "Log in" }).click();
  await page.waitForURL("/dashboard");

  await page.context().storageState({ path: authFile });
});
```

:::

:::details invoice.test.ts

```typescript
import { test, expect } from "@playwright/test";

test.beforeEach(async ({ page }) => {
  await page.goto("http://localhost:3000/dashboard/invoices");
});

test("請求書の登録", async ({ page }) => {
  await expect(
    page.getByRole("heading", { name: "Invoices", level: 1 })
  ).toBeVisible();

  // フォーム入力
  await page.getByRole("link", { name: "Create Invoice" }).click();
  await page
    .getByRole("combobox", { name: "Choose customer" })
    .selectOption({ label: "Balazs Orban" });
  await page
    .getByRole("spinbutton", { name: "choose an amount" })
    .fill("123456");
  await page.getByRole("radio", { name: "Pending" }).click();

  // フォーム送信
  await page.getByRole("button", { name: "Create Invoice" }).click();
  await page.waitForURL("/dashboard/invoices");

  // テーブルの一番上に表示されていることを検証
  await expect(
    page.locator("table > tbody > tr:nth-of-type(1) > td:nth-of-type(1)")
  ).toHaveText("Balazs Orban");
  await expect(
    page.locator("table > tbody > tr:nth-of-type(1) > td:nth-of-type(2)")
  ).toHaveText("$123,456.00");
});

test("請求書の更新", async ({ page }) => {});

test("請求書の削除", async ({ page }) => {});
```

:::

#### 詳細

`auth.setup.ts` では認証処理を実行しています。Playwright の認証機能を利用することで、テスト開始時に一度だけ認証処理を行い、以降は認証済みの状態でテストを実行できます。
仕組みとして、初回の認証処理で JSON ファイルが生成され、これをストレージに保存します。
各テストではその JSON ファイルをブラウザが読み込むことでログイン状態を再現します。

https://playwright.dev/docs/auth

実際に生成される JSON ファイルに認証情報が入っていることが確認できました。

::: details user.json

```json
{
  "cookies": [
    {
      "name": "authjs.csrf-token",
      "value": "56a3d4c3e91898d8f0610f53dd070b7adc0acece10fcfca1f437d29a99bbb3be%7C7d92311a21d45e8b835ff33a7f982dbc2f8be0d0178c8aae7db2905c36ec7201",
      "domain": "localhost",
      "path": "/",
      "expires": -1,
      "httpOnly": true,
      "secure": false,
      "sameSite": "Lax"
    },
    {
      "name": "authjs.callback-url",
      "value": "http%3A%2F%2Flocalhost%3A3000%2Flogin",
      "domain": "localhost",
      "path": "/",
      "expires": -1,
      "httpOnly": true,
      "secure": false,
      "sameSite": "Lax"
    },
    {
      "name": "authjs.session-token",
      "value": "eyJhbGciOiJkaXIiLCJlbmMiOiJBMjU2R0NNIn0..zrs2p5-TIDyPCAkN.YiiAH40oSCm33pPNTRpbuIjNYzVmYzUYhbiuD9ujgW2e9sQiV25NA1a2OkQl7K8lHuko1t_tebBApQ5O_162k7LaixjBxjdPopG7X5CCdAbMIs_YVHz5cVpy-h_PRWxqmNTqvxSdwiF-wYiUU3yeneMjNMLGiKC9Hs_ogbItV2UGIT4ZqlUUEzkWu_nH2CtwQ-PX14ahWIx8wgDD13NOl0engQ12BJQ.5NBpLiKaSj4TYP14Qk9zJw",
      "domain": "localhost",
      "path": "/",
      "expires": 1736177763.205842,
      "httpOnly": true,
      "secure": false,
      "sameSite": "Lax"
    }
  ],
  "origins": []
}
```

:::

故に、`invoice.test.ts`ではログイン処理はすでに完了しており、ログイン後の状態でテストを実行しています。
このページのテストでは、登録、更新、削除といった操作をテストできますが、各操作ごとにログイン処理を記述する必要がないため、コードのメンテナンス性が向上します。

テストが通ることが確認できました！

```bash
yarn test
yarn run v1.22.22
$ playwright test

Running 10 tests using 8 workers
  10 passed (5.8s)

To open last HTML report run:

  yarn playwright show-report

✨  Done in 6.25s.
```
